var io;
var gameSocket;
var rooms = {};
exports.initGame = function(sio,socket){
	io = sio;
	gameSocket = socket;

	
	gameSocket.emit('connected', { message: "You are connected!" });
    // Host Events
    gameSocket.on('hostCreateNewGame', hostCreateNewGame);
    gameSocket.on('playerJoinGame',playerJoinGame);
    gameSocket.on('updatePlayerPlayersServer',updatePlayerPlayersServer);
    gameSocket.on('chatMessage',chatMessage);
    gameSocket.on('startGame',startGame);
    gameSocket.on('mousemove',mousemove);
    gameSocket.on('gameEnd',gameEnd);
}
function randomProperty(object) {
  var keys = Object.keys(object);
  return keys[Math.floor(keys.length * Math.random())];
};

function hostCreateNewGame(data){

	var gameID =  (Math.random()*100000) | 0 ;
	data.gameID = gameID;
	data.mySocketID = this.id;
	this.emit('newGameCreated',data);
	this.join(gameID.toString());
}
function playerJoinGame(data) {
    var sock = this;
    var room = gameSocket.manager.rooms["/" + data.gameID];
    var gameID = data.gameID;
    console.log(gameSocket.manager.rooms["/" + data.gameID]);
    if( room != undefined ){
        data.mySocketID = sock.id;
        sock.join(data.gameID);
        io.sockets.in(data.gameID).emit('playerJoinedRoom', data);

    } else {

        this.emit('error',{message: "This room does not exist."} );
    }
    if (rooms[gameID] == undefined){
        rooms[gameID] = "waiting";
    }
    console.log(rooms);
    if (rooms[gameID]=="playing"){
        this.emit('prepareStartGame',{id:"not_you",word:"BIRD"});
    }
}
function updatePlayerPlayersServer(data) {
   	io.sockets.in(data[0].gameID).emit('updatePlayerPlayers',data);
}
function chatMessage(data) {
   	io.sockets.in(data.gameID).emit('newChatMessage',data);
}
function startGame(data) {
    console.log(data);
    io.sockets.in(data).emit('prepareStartGame',{id:io.sockets.clients(data)[Math.floor(io.sockets.clients(data).length * Math.random())].id,word:"BIRD"});
    rooms[data] = "playing";
}
function mousemove(data){
    this.broadcast.to(data.gameID).emit('isMoving',data);
}
function gameEnd(data){
    //{winner_name}
    console.log(data);
    rooms[data.gameID]="waiting";
    io.sockets.in(data.gameID).emit('gameEnded',data.name);
}